<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â–ç­çº§è€ƒå‹¤ç³»ç»Ÿ V2.0[bata] - Xiaoran9116</title>
    <style>
        /*æçªçªè€ƒå‹¤ç­¾åˆ°ç³»ç»Ÿæ”¹ç‰ˆ-xiaoran9116*/
        :root { --primary-color: #1a2a6c; --accent-color: #fdbb2d; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); 
            background-size: cover; background-position: center;
            color: white; height: 100vh; display: flex; flex-direction: column; padding: 10px; overflow: hidden; position: relative; 
        }

        /* --- 1. å¼€å±åŠ¨ç”» --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; 
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            animation: fadeOut 1s ease-in-out 3.5s forwards;
            background-size: cover; background-position: center;
        }
        .intro-content { text-align: center; animation: zoomIn 1.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; padding: 40px; }
        .intro-icon { font-size: 5rem; margin-bottom: 20px; display: block; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.8); }
        .intro-text { 
            font-size: 2.5rem; letter-spacing: 2px; font-weight: 800; /* ç²—ä½“ */
            background: linear-gradient(90deg, #fff, #a8c0ff); -webkit-background-clip: text; color: transparent;
            font-family: 'Segoe UI', sans-serif; text-transform: uppercase;
        }
        .intro-sub {
            position: absolute; bottom: -20px; right: 20px;
            font-size: 0.9rem; color: rgba(255,255,255,0.6); font-family: monospace; letter-spacing: 1px;
        }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- 2. ä¸»ç•Œé¢å¸ƒå±€ --- */
        .header { text-align: center; margin-bottom: 10px; flex-shrink: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .main-container { display: flex; flex: 1; gap: 15px; overflow: hidden; height: calc(100vh - 120px); }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 15px; }
        .glass-panel { 
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); 
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .time { font-size: 3rem; font-weight: 300; line-height: 1.1; margin-bottom: 5px; }
        .date-group { opacity: 0.9; font-size: 1rem; }
        .announcement { margin-top:10px; text-align:left; font-size:0.95rem; color: #fff; min-height:48px; }
        .announcement .ann-title { font-weight:700; margin-bottom:6px; }
        /* è€ƒå‹¤ç»Ÿè®¡ */
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.95rem; }
        .deadline-list { margin-top: 10px; flex: 1; overflow-y: auto; text-align: left; }
        .deadline-item { padding: 4px 8px; font-size: 0.85rem; color: rgba(255,255,255,0.8); }

        /* åå•åŒºåŸŸ */
        .names-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .section-title { font-size: 1.3rem; margin-bottom: 12px; text-align: center; padding-bottom: 6px; border-bottom: 2px solid rgba(255, 255, 255, 0.3); }
        .names-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; padding: 5px; flex: 1; }
        .names-grid::-webkit-scrollbar { width: 6px; }
        .names-grid::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        .names-grid::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        
        
        .name-card {
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 0 10px;
            height: 55px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
            font-size: 1rem; letter-spacing: 1px;
        }
        .name-card:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.3); }
        /* å­¦ç”Ÿå¡ç‰‡ */
        .name-card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); border-radius: 8px; padding: 10px 6px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.9rem; position: relative; display: flex; justify-content: center; align-items: center; min-height: 50px; }
        .name-card:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.3); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        .name-card.checked { background: rgba(46, 204, 113, 0.4); color: white; }
        .name-card.late { background: rgba(231, 76, 60, 0.4); color: white; cursor: not-allowed; }
        .checkmark { position: absolute; right: 4px; top: 4px; font-size: 0.9rem; color: #2ecc71; }
        .late-text { position: absolute; right: 4px; bottom: 3px; font-size: 0.65rem; color: #e74c3c; }
        
        /* ç­¾åˆ°åï¼šç™½è‰²ä¸é€æ˜ */
        .name-card.checked {
            background: #ffffff !important; /* çº¯ç™½ */
            color: #333 !important; /* æ·±è‰²å­—ä½“ */
            opacity: 1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: none;
            font-weight: bold;
        }
        /* è¿Ÿåˆ°æ ·å¼ */
        .name-card.late {
            background: rgba(231, 76, 60, 0.8) !important;
            color: white; border: 1px solid #c0392b;
            cursor: not-allowed;
        }
        
        .card-icon { font-size: 1.2rem; font-weight: bold; }
        .checked .card-icon { color: #27ae60; } /* ç»¿è‰²å¯¹å‹¾ */

        .names-grid.fullscreen-mode .name-card {
            height: 80px; /* å¢åŠ å¡ç‰‡é«˜åº¦ */
            font-size: 1.5rem; /* å¢å¤§å­—ä½“ */
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .footer { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .admin-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; color: #ccc; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
        .admin-btn:hover { background: rgba(0,0,0,0.5); color: #fff; }

        /* æ°´å° */
        #watermark { position: fixed; bottom: 5px; right: 10px; font-size: 0.7rem; color: rgba(255,255,255,0.3); font-family: 'Consolas', monospace; pointer-events: none; }

        /* --- 4. ç»“æŸç»“ç®—ç”»é¢ (End Screen) --- */
        #end-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            z-index: 8000; flex-direction: column; justify-content: center; align-items: center;
            animation: fadeIn 0.5s ease-out;
        }
        .end-title { font-size: 3rem; color: #fdbb2d; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 5px; border-bottom: 2px solid #fdbb2d; padding-bottom: 10px; }
        .late-list-container { 
            background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; 
            max-width: 600px; width: 80%; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .late-list-title { font-size: 1.2rem; color: #e74c3c; margin-bottom: 15px; }
        .late-names { font-size: 1.1rem; line-height: 1.8; color: #fff; }
        .close-end-btn { margin-top: 30px; padding: 10px 30px; background: transparent; border: 1px solid #fff; color: #fff; border-radius: 50px; cursor: pointer; transition: 0.3s; }
        .close-end-btn:hover { background: #fff; color: #000; }

        /* --- 5. åå°ç®¡ç†å…¨å±ç•Œé¢ --- */
        #admin-page {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f4f6f9; color: #333; z-index: 9000;
            flex-direction: column;
        }
        .admin-header { background: #1a2a6c; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-body { flex: 1; display: flex; overflow: hidden; }
        .admin-sidebar { width: 200px; background: white; padding: 20px 0; border-right: 1px solid #eee; }
        .tab-btn { display: block; width: 100%; text-align: left; padding: 12px 20px; border: none; background: transparent; cursor: pointer; color: #666; font-size: 1rem; border-left: 4px solid transparent; }
        .tab-btn.active { background: #eef2f7; color: #1a2a6c; border-left-color: #1a2a6c; font-weight: bold; }
        .admin-content { flex: 1; padding: 30px; overflow-y: auto; }
        .settings-group { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .settings-title { font-size: 1.2rem; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #2c3e50; }
        
        /* è¡¨å•å…ƒç´  */
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .form-control { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .check-item:hover { background: #f0f0f0; }
        .btn { padding: 8px 20px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9rem; }
        .btn-save { background: #1a2a6c; color: white; }
        .file-upload { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }

        /* Login Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9500; display: none; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; color: #333; width: 320px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }

        /* æŠ¥è¡¨é¡µé¢çš„æ ·å¼ï¼ˆæ–°æ ‡ç­¾é¡µä¼šç”¨åˆ°ï¼‰ */
        .report-body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; padding: 20px; background-color: #f8f9fa; color: #333; }
        .report-title { color: #1a2a6c; border-bottom: 3px solid #fdbb2d; padding-bottom: 10px; margin-bottom: 20px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .report-table th { background-color: #e9ecef; color: #1a2a6c; font-weight: bold; }
        .late-row { background-color: #fdd; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="intro-overlay">
        <div class="intro-content">
            <span class="intro-icon">â–</span>
            <div class="intro-text">Unstained science of technology</div>
            <div class="intro-sub">- Xiaoran9116</div>
        </div>
    </div>

    <div id="end-screen">
        <div class="end-title">æœ¬æ¬¡è€ƒå‹¤å·²ç»“æŸ</div>
        <div class="late-list-container">
            <div class="late-list-title">âš  è¿Ÿåˆ°/æœªåˆ°äººå‘˜åå•</div>
            <div class="late-names" id="endScreenNames">æ— </div>
        </div>
        <button class="close-end-btn" onclick="document.getElementById('end-screen').style.display='none'">å…³é—­ç”»é¢</button>
    </div>

    <div id="watermark">- Xiaoran9116</div>

    <div class="header">
        <h1>ç­çº§è€ƒå‹¤æ—¶é’Ÿç³»ç»Ÿ</h1>
        <div class="status" id="attendanceStatus">åˆå§‹åŒ–...</div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="glass-panel">
                <div class="time" id="time">00:00:00</div>
                <div class="date-group">
                    <div id="date">YYYY/MM/DD</div>
                    <div id="weekday">Monday</div>
                </div>
                <div class="announcement" id="announcement">
                    <div class="ann-title">å…¬å‘Š</div>
                    <div id="announcementText">ä¿®å¤å…¨å‘˜è¿Ÿåˆ°bug æˆªè‡³v2.0ç‰ˆæœ¬ä»£ç é•¿åº¦æ¥åˆ°912è¡Œ
                   </div>
                </div>
            </div>         
            <div class="glass-panel" style="flex: 1; display: flex; flex-direction: column; text-align: left;">
                <div class="info-row"><span>åº”åˆ°:</span> <strong id="totalCount">0</strong></div>
                <div class="info-row"><span>å®åˆ°:</span> <strong id="presentCount" style="color:#2ecc71">0</strong></div>
                <div class="info-row"><span>è¿Ÿåˆ°:</span> <strong id="lateCount" style="color:#e74c3c">0</strong></div>
                
                <div style="margin-top: 15px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom:5px;">è€ƒå‹¤æ—¶æ®µ</div>
                <div class="deadline-list" id="deadlineList">
                </div>
            </div>
        </div>

        <div class="names-section">
            <div class="names-grid" id="namesGrid">
            </div>
        </div>
    </div>

    <div class="footer">
        <div style="font-size: 0.8rem; opacity: 0.7;">System Ready</div>
        <div style="display: flex; gap: 10px; align-items:center;">
            <button class="admin-btn" onclick="openAttendanceReport()">æŸ¥çœ‹è¿Ÿåˆ°åå•</button>
            <button class="admin-btn" onclick="document.getElementById('loginModal').style.display='flex'">ç®¡ç†åå°</button>                    
            <button class="admin-btn" id="themeBtn" onclick="cycleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="login-box">
            <h3>ç®¡ç†å‘˜éªŒè¯</h3>
            <input type="text" id="uName" class="login-input" placeholder="ç”¨æˆ·å">
            <input type="password" id="pWord" class="login-input" placeholder="å¯†ç ">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" style="background:#ccc" onclick="document.getElementById('loginModal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-save" onclick="handleLogin()">ç™»å½•</button>
            </div>
        </div>
    </div>

    <div id="admin-page">
        <div class="admin-header">
            <h3>âš™ï¸ è€ƒå‹¤ç³»ç»Ÿåå°ç®¡ç† V:2.0[Bata]</h3>
            <button class="btn" style="background: rgba(255,255,255,0.2); color:white;" onclick="closeAdmin()">é€€å‡ºåå°</button>
        </div>
        <div class="admin-body">
            <div class="admin-sidebar">
                <button class="tab-btn active" onclick="switchTab('tab-time', this)">ğŸ“… æ—¶é—´è®¾ç½®</button>
                <button class="tab-btn" onclick="switchTab('tab-person', this)">ğŸ‘¥ äººå‘˜ä¸è‡ªåŠ¨ç­¾åˆ°</button>
                <button class="tab-btn" onclick="switchTab('tab-theme', this)">ğŸ¨ å¤–è§‚ä¸ç´ æ</button>
                <button class="tab-btn" onclick="switchTab('tab-ann', this)">ğŸ“ å…¬å‘Šç¼–è¾‘</button>
            </div>
            
            <div class="admin-content">
                <div id="tab-time" class="settings-group">
                    <div class="settings-title">è€ƒå‹¤æ—¶é—´æ®µé…ç½®</div>
                    <div id="periodsContainer"></div>
                </div>

                <div id="tab-person" class="settings-group" style="display:none;">
                    <div class="settings-title">äººå‘˜åå•ç®¡ç†</div>
                    <div class="form-row">
                        <label style="width:120px;">è‡ªåŠ¨ç­¾åˆ°æœ‰æ•ˆæœŸ(å¤©)</label>
                        <input type="number" class="form-control" id="autoExpireInput" value="7" onchange="config.autoSignExpireDays=parseInt(this.value)">
                    </div>

                    <p style="font-size:0.9rem; color:#666; margin-bottom: 10px;" id="autoNote">
                        å‹¾é€‰ä¸‹æ–¹äººå‘˜ï¼Œå°†åœ¨è€ƒå‹¤å¼€å§‹æ—¶<strong>è‡ªåŠ¨ç­¾åˆ°</strong>ï¼ˆæ˜¾ç¤ºä¸ºå·²åˆ°ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨æ‰“å¡ã€‚
                    </p>
                    <div class="check-grid" id="autoSignGrid">
                    </div>
                </div>

                <div id="tab-theme" class="settings-group" style="display:none;">
                    <div class="settings-title">ç´ æå¯¼å…¥</div>
                    
                    <label>è‡ªå®šä¹‰èƒŒæ™¯å›¾</label>
                    <div class="file-upload" onclick="document.getElementById('bgInput').click()">
                        ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (å»ºè®® < 2MB)
                        <input type="file" id="bgInput" hidden accept="image/*" onchange="importFile(this, 'customBg')">
                    </div>
                    <button class="btn" style="background:#e74c3c; color:white; font-size:0.8rem" onclick="clearStorage('customBg')">æ¸…é™¤èƒŒæ™¯</button>

                    <br><br>
                    <label>å¼€å±èƒŒæ™¯å›¾</label>
                    <div class="file-upload" onclick="document.getElementById('introInput').click()">
                        ç‚¹å‡»ä¸Šä¼  (è¦†ç›–é»˜è®¤é»‘è‰²èƒŒæ™¯)
                        <input type="file" id="introInput" hidden accept="image/*" onchange="importFile(this, 'introBg')">
                    </div>

                </div>

                <div id="tab-ann" class="settings-group" style="display:none;">
                    <div class="settings-title">å…¬å‘Šç¼–è¾‘</div>
                    <div class="form-row">
                        <textarea id="annEditor" class="form-control" style="height:120px; resize:vertical;"></textarea>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn" onclick="loadAnnouncement()">è¿˜åŸæœ¬åœ°å†…å®¹</button>
                        <button class="btn btn-save" onclick="saveAnnouncement()">ä¿å­˜å…¬å‘Š</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        /* --- å…¨å±€æ•°æ® --- */
        const ALL_NAMES = [
            "é™ˆå¸ŒèŒ", "ç¨‹å…ˆæ°‘", "å†¯é–é›¯", "å†¯ä¿Šçš“", "éƒ­æ™¨ç®", "éƒ­æ™¨æº", 
            "ä¾¯ä½³éœ–", "æ±Ÿé›¨éœ", "å¯‡ç‘¾ç‘„", "æç‘ç¨‹", "ææ€æ¶µ", "æå½¦æ± ", 
            "åˆ˜æµ©å®‡", "åˆ˜æ€è¯º", "åˆ˜æ€¡å›", "åˆ˜ç›Šè±ª", "ç‰›å†›åš", "äº“å¨…ç’‡", 
            "ç§¦å›½è±ª", "å²ç»§ç¡•", "å²å³»ç†™", "å¸ä¹¦å¸†", "å­™æ¥šæ™´", "å­™è‰ºæ¶µ", 
            "ç‹ä¿Šæ¸…", "é˜ä¹¦æ¶¦", "æ¨ç’ç¾½", "æ¨é•‡å®‡", "å¼ å’Œç…¦", "å¼ å˜‰æ€¡", 
            "å¼ å‡Œç¡•", "å¼ çº³ç»®", "èµµè‰ºæ´", "èµµå­å¢¨"
        ];

        // é»˜è®¤é…ç½®
        let config = JSON.parse(localStorage.getItem('attendance_v4_config')) || {
            periods: [
                { name: "ä¸Šåˆ", start: "05:55", end: "06:54" },
                { name: "ä¸­åˆ", start: "12:44", end: "13:45" },
                { name: "æ™šä¸Š", start: "17:30", end: "18:29" }
            ],
            autoSignList: [], // è‡ªåŠ¨ç­¾åˆ°çš„äººååˆ—è¡¨
            autoSignExpireDays: 7
        };

        // ä¸»é¢˜é¢„è®¾ (5 ç§)
        const THEMES = [
            {bg: 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)', primary:'#1a2a6c', accent:'#fdbb2d'},
            {bg: 'linear-gradient(135deg, #0f5b7b, #2b8a7a, #7ad9a2)', primary:'#0f5b7b', accent:'#7ad9a2'},
            {bg: 'linear-gradient(135deg, #2b5876, #4e4376)', primary:'#2b5876', accent:'#f6c',},
            {bg: 'linear-gradient(135deg, #232526, #414345)', primary:'#232526', accent:'#9bd'},
            {bg: 'linear-gradient(135deg, #4b6cb7, #182848)', primary:'#4b6cb7', accent:'#ffd166'}
        ];

        let themeIndex = parseInt(localStorage.getItem('attendance_theme_index')||'0');

        // ç™»å½•ç”¨æˆ·è§’è‰²
        let currentUserRole = null; // 'primary'|'secondary'

        // çŠ¶æ€æ ‡è®°ï¼Œé˜²æ­¢ç»“æŸç”»é¢é‡å¤å¼¹å‡º
        let lastLockedState = false;

        /* --- æ ¸å¿ƒé€»è¾‘ --- */
        
        function init() {
            loadTheme();
            loadAnnouncement();
            initGrid();
            renderSettings();
            setInterval(tick, 1000);
            tick();
        }

        // åŠ è½½å¤–è§‚
        function loadTheme() {
            const bg = localStorage.getItem('customBg');
            if(bg) document.body.style.backgroundImage = `url(${bg})`; else document.body.style.backgroundImage = '';
            document.body.style.background = THEMES[themeIndex].bg || THEMES[0].bg;
            document.documentElement.style.setProperty('--primary-color', THEMES[themeIndex].primary || '#1a2a6c');
            document.documentElement.style.setProperty('--accent-color', THEMES[themeIndex].accent || '#fdbb2d');
            localStorage.setItem('attendance_theme_index', themeIndex);
            const introBg = localStorage.getItem('introBg');
            if(introBg) document.getElementById('intro-overlay').style.backgroundImage = `url(${introBg})`;
        }

        function cycleTheme(){
            themeIndex = (themeIndex + 1) % THEMES.length;
            loadTheme();
        }

        // å­˜åœ¨å…¬å‘Šåˆ™åŠ è½½
        function loadAnnouncement(){
            const ann = localStorage.getItem('attendance_announcement') || 'æš‚æ— å…¬å‘Šã€‚ç®¡ç†å‘˜å¯åœ¨åå°ç¼–è¾‘æ­¤å¤„å†…å®¹ã€‚';
            document.getElementById('announcementText').innerText = ann;
            document.getElementById('annEditor') && (document.getElementById('annEditor').value = ann);
        }
        function saveAnnouncement(){
            const text = document.getElementById('annEditor').value || '';
            localStorage.setItem('attendance_announcement', text);
            loadAnnouncement();
            alert('å…¬å‘Šå·²ä¿å­˜');
        }

        // åˆå§‹åŒ–/åˆ·æ–°åå•ç½‘æ ¼
        function initGrid() {
            const grid = document.getElementById('namesGrid');
            grid.innerHTML = '';
            document.getElementById('totalCount').textContent = ALL_NAMES.length;
            
            // æ›´æ–°å·¦ä¾§æ—¶é—´åˆ—è¡¨
            const dlList = document.getElementById('deadlineList');
            dlList.innerHTML = config.periods.map(p => `<div class="deadline-item">${p.name}: ${p.start} - ${p.end}</div>`).join('');

            ALL_NAMES.forEach(name => {
                const card = document.createElement('div');
                card.className = 'name-card';
                card.dataset.name = name;
                card.dataset.status = 'absent'; // æ–°å¢ï¼šåˆå§‹çŠ¶æ€
                card.dataset.checkTime = ''; // æ–°å¢ï¼šç­¾åˆ°æ—¶é—´
                // æ·»åŠ è‡ªåŠ¨ç­¾åˆ°æ ‡è®°
                const isAuto = config.autoSignList.includes(name);
                card.innerHTML = `
                    <span style="font-weight:500">${name}</span>
                    <span style="font-size: 0.7em; color: #fdbb2d; position:absolute; top:3px; left:3px; opacity: ${isAuto ? 0.7 : 0};">â˜…</span>
                    <span class="card-icon"></span>
                `;
                
                card.onclick = () => handleCardClick(card);
                grid.appendChild(card);
            });
            updateStats();
        }

        function handleCardClick(card){
            if (!isActive()) {
                // éè€ƒå‹¤æ—¶æ®µï¼šä¸åšä»»ä½•å¼¹çª—æˆ–å¤§æ—¶é’Ÿï¼ˆå·²ç§»é™¤ï¼‰
                return;
            }
            // æ­£å¸¸è€ƒå‹¤æœŸé—´çš„ç‚¹å‡»
            if (isLocked()) return; // é”å®šåä¸å¯ç‚¹
            if (card.classList.contains('late')) return; // è¿Ÿåˆ°çŠ¶æ€ï¼Œä¸å¯æ‰‹åŠ¨ç­¾åˆ°

            const now = new Date();
            const nowTime = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

            if (card.classList.contains('checked')) {
                // å–æ¶ˆç­¾åˆ°
                card.classList.remove('checked');
                card.querySelector('.card-icon').textContent = '';
                card.dataset.status = 'absent'; // æ›´æ”¹çŠ¶æ€
                card.dataset.checkTime = ''; // æ¸…é™¤æ—¶é—´
            } else {
                // ç­¾åˆ°ï¼šå˜ç™½ + æ‰“é’©
                card.classList.add('checked');
                card.querySelector('.card-icon').textContent = 'âœ“';
                card.dataset.status = 'present'; // æ›´æ”¹çŠ¶æ€
                card.dataset.checkTime = nowTime; // è®°å½•æ—¶é—´
            }
            updateStats();
        }

        // è‡ªåŠ¨ç­¾åˆ°å¤„ç†
        function checkAutoSign() {
            if (isActive() && !isLocked()) {
                const cards = document.querySelectorAll('.names-grid .name-card');
                const now = new Date();
                const nowTime = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                cards.forEach(card => {
                    const name = card.dataset.name;
                    // å¦‚æœåœ¨è‡ªåŠ¨ç­¾åˆ°åå•é‡Œï¼Œä¸”è¿˜æ²¡ç­¾åˆ°ï¼Œä¸”æ²¡è¿Ÿåˆ°
                    if (config.autoSignList.includes(name) && !card.classList.contains('checked') && !card.classList.contains('late')) {
                        card.classList.add('checked');
                        card.querySelector('.card-icon').textContent = 'âœ“';
                        card.dataset.status = 'present'; // æ›´æ”¹çŠ¶æ€
                        card.dataset.checkTime = nowTime; // è®°å½•æ—¶é—´
                    }
                });
                updateStats(); // å®æ—¶æ›´æ–°æ•°æ®
            }
        }

        // æ—¶é—´ä¸çŠ¶æ€å¾ªç¯
        function tick() {
            const now = new Date();
            // 1. UI Update
            document.getElementById('time').innerHTML = 
                `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
            document.getElementById('date').innerText = now.toLocaleDateString();
            document.getElementById('weekday').innerText = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][now.getDay()]; // è½¬æ¢ä¸ºä¸­æ–‡

            // 2. Logic Check
            const active = isActive();
            const locked = isLocked();
            const statusDiv = document.getElementById('attendanceStatus');

            if (locked) {
                // åˆšè¿›å…¥é”å®šçŠ¶æ€æ—¶ï¼Œè§¦å‘ä¸€æ¬¡ç»“ç®—ï¼Œä½†é¿å…é‡å¤ç»“ç®—ï¼ˆåŒ…æ‹¬åˆ·æ–°åï¼‰
                if (!lastLockedState) {
                    if (!isAlreadyFinalized()) finalizeAttendance();
                    lastLockedState = true;
                }
                statusDiv.textContent = "è€ƒå‹¤å·²ç»“æŸ";
                statusDiv.style.color = "#fdbb2d";
            } else if (active) {
                lastLockedState = false; // é‡ç½®çŠ¶æ€ä½
                checkAutoSign(); // è¿è¡Œè‡ªåŠ¨ç­¾åˆ°
                statusDiv.textContent = `è€ƒå‹¤è¿›è¡Œä¸­ (${getCurrentPeriodName()})`;
                statusDiv.style.color = "#2ecc71";
            } else {
                // å¦‚æœå½“å‰çŠ¶æ€ä¸æ˜¯é”å®šï¼Œå¹¶ä¸”ä¸æ˜¯è€ƒå‹¤ä¸­ï¼Œä¸”ä¸Šæ¬¡æ˜¯é”å®šçŠ¶æ€ï¼Œåˆ™æ¸…é™¤è¿Ÿåˆ°çŠ¶æ€
                if (lastLockedState) {
                    resetAttendance(false); // ä»…æ¸…é™¤ late çŠ¶æ€
                }
                lastLockedState = false;
                statusDiv.textContent = "ç­‰å¾…ä¸‹ä¸€æ—¶æ®µ";
                statusDiv.style.color = "white";
            }
        }

        function isAlreadyFinalized(){
            try{
                const f = JSON.parse(localStorage.getItem('attendance_finalized')||'{}');
                const now = new Date();
                const today = now.toISOString().slice(0,10);
                const period = getCurrentPeriodName();
                return f.date === today && f.period === period;
            }catch(e){return false}
        }

        // ç»“ç®—é€»è¾‘ (å¼¹å‡ºç»“æŸç”»é¢)
        function finalizeAttendance() {
            const cards = document.querySelectorAll('.names-grid .name-card');
            const lateNames = [];
            
            cards.forEach(card => {
                if (!card.classList.contains('checked')) {
                    // æœªç­¾åˆ°çš„å…¨éƒ¨æ ‡è®°ä¸ºè¿Ÿåˆ°/ç¼ºå¸­
                    card.classList.add('late');
                    card.querySelector('.card-icon').textContent = 'âš ';
                    card.dataset.status = 'late'; // æ›´æ”¹çŠ¶æ€ä¸ºè¿Ÿåˆ°
                    card.dataset.checkTime = 'ç¼ºå¸­'; // æ ‡è®°ç¼ºå¸­
                    lateNames.push(card.dataset.name);
                }
            });
            updateStats();

            // æ ‡è®°ä¸ºå·²ç»“ç®—ï¼Œé¿å…åˆ·æ–°åé‡å¤ç»“ç®—
            try{
                const now = new Date();
                const today = now.toISOString().slice(0,10);
                const period = getCurrentPeriodName();
                localStorage.setItem('attendance_finalized', JSON.stringify({date: today, period: period}));
            }catch(e){}

            // å¼¹å‡ºç”»é¢
            const endScreen = document.getElementById('end-screen');
            const listDiv = document.getElementById('endScreenNames');
            listDiv.textContent = lateNames.length > 0 ? lateNames.join(', ') : "å…¨å‘˜åˆ°é½ï¼å®Œç¾ï¼";
            endScreen.style.display = 'flex';
        }

        // è¾…åŠ©å‡½æ•°
        function pad(n) { return n < 10 ? '0'+n : n; }
        function getMins(timeStr) { 
            if (!timeStr || timeStr.indexOf(':') === -1) return -1;
            const [h, m] = timeStr.split(':'); 
            return parseInt(h) * 60 + parseInt(m); 
        }
        
        function isActive() {
            const now = new Date();
            const cur = now.getHours() * 60 + now.getMinutes();
            return config.periods.some(p => {
                const startMins = getMins(p.start);
                const endMins = getMins(p.end);
                return startMins !== -1 && endMins !== -1 && cur >= startMins && cur <= endMins;
            });
        }
        
        function isLocked() {
            const now = new Date();
            const cur = now.getHours() * 60 + now.getMinutes();
            // ç»“æŸå30åˆ†é’Ÿå†…è§†ä¸ºé”å®šï¼ˆæ˜¾ç¤ºç»“ç®—ï¼‰ï¼Œä¹‹åæ¢å¤æ™®é€šç­‰å¾…
            return config.periods.some(p => {
                const endMins = getMins(p.end);
                return endMins !== -1 && cur > endMins && cur <= endMins + 30;
            });
        }

        function getCurrentPeriodName() {
            const now = new Date();
            const cur = now.getHours() * 60 + now.getMinutes();
            const p = config.periods.find(p => cur >= getMins(p.start) && cur <= getMins(p.end));
            return p ? p.name : '';
        }

        function getNextPeriod(){
            const now = new Date();
            const cur = now.getHours()*60 + now.getMinutes();
            const future = config.periods.filter(p=> getMins(p.start) > cur).sort((a,b)=> getMins(a.start)-getMins(b.start));
            return future.length? future[0] : null;
        }

        function updateStats() {
            const checked = document.querySelectorAll('.names-grid .name-card.checked').length;
            const late = document.querySelectorAll('.names-grid .name-card.late').length;
            document.getElementById('presentCount').textContent = checked;
            document.getElementById('lateCount').textContent = late;
        }

        /**
         * é‡ç½®è€ƒå‹¤çŠ¶æ€
         * @param {boolean} fullReset - æ˜¯å¦å®Œå…¨é‡ç½® (æ¸…é™¤ checked å’Œ late)ï¼Œå¦åˆ™åªæ¸…é™¤ late çŠ¶æ€
         */
        function resetAttendance(fullReset = true) {
            if (isLocked() && fullReset) { alert('å½“å‰å¤„äºç»“æŸç»“ç®—æ—¶æ®µï¼Œæ— æ³•é‡ç½®'); return; }
            
            document.querySelectorAll('.names-grid .name-card').forEach(c => {
                if (fullReset) {
                    // å®Œå…¨é‡ç½®ï¼ˆæŒ‰é’®ç‚¹å‡»ï¼‰
                    c.className = 'name-card';
                    c.dataset.status = 'absent';
                    c.dataset.checkTime = '';
                } else {
                    // éå®Œå…¨é‡ç½®ï¼ˆæ—¶é—´æ®µç»“æŸè‡ªåŠ¨æ¸…é™¤ï¼‰
                    c.classList.remove('late');
                    if (c.dataset.status === 'late') {
                        c.dataset.status = 'absent'; // æ¸…é™¤ late çŠ¶æ€åï¼Œæœªç­¾åˆ°çš„åº”æ¢å¤ absent
                        c.dataset.checkTime = '';
                    }
                }
                c.querySelector('.card-icon').textContent = '';
                
                // ç¡®ä¿è‡ªåŠ¨ç­¾åˆ°çš„äººåœ¨é‡ç½®åå¦‚æœ autoSignList ä¸­è¿˜æœ‰åå­—ï¼Œä¸ä¼šé©¬ä¸Šæ¸…é™¤ checked
                if (config.autoSignList.includes(c.dataset.name) && isActive() && !isLocked()) {
                    const now = new Date();
                    c.classList.add('checked');
                    c.querySelector('.card-icon').textContent = 'âœ“';
                    c.dataset.status = 'present';
                    c.dataset.checkTime = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                }
            });
            updateStats();
            // å¦‚æœæ˜¯å®Œå…¨é‡ç½®åˆ™æ¸…é™¤å·²ç»“ç®—æ ‡è®°
            if(fullReset) localStorage.removeItem('attendance_finalized');
        }
        
        /* --- æ–°å¢: å…¨å±æ¨¡å¼é€»è¾‘ (æœªåœ¨ footer ä¸­æ·»åŠ æŒ‰é’®ï¼Œä»…ä¿ç•™å‡½æ•°) --- */
        function toggleFullscreen() {
            const grid = document.getElementById('namesGrid');
            const button = event.target;
            
            grid.classList.toggle('fullscreen-mode');
            
            if (grid.classList.contains('fullscreen-mode')) {
                // è¿›å…¥å…¨å±é€»è¾‘ (ä»…å½±å“ç½‘æ ¼æ ·å¼ï¼Œéæµè§ˆå™¨åŸç”Ÿå…¨å±)
                button.textContent = "é€€å‡ºå…¨å±";
            } else {
                button.textContent = "å…¨å±æ¨¡å¼";
            }
        }

        /* --- æ–°å¢: è€ƒå‹¤åå•æŠ¥è¡¨ (ç²¾ç¡®åˆ°ç§’) --- */
        function openAttendanceReport() {
            const cards = Array.from(document.querySelectorAll('.names-grid .name-card'));
            const reportData = cards.map(card => ({
                name: card.dataset.name,
                status: card.dataset.status, // 'present', 'late', 'absent'
                checkTime: card.dataset.checkTime 
            }));

            // æ ¼å¼åŒ–å½“å‰æ—¶é—´
            const now = new Date();
            const currentDateTime = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }) + ' ' + 
                                  now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            
            let tableRows = '';
            reportData.sort((a, b) => {
                if (a.status === 'late' && b.status !== 'late') return -1;
                if (a.status !== 'late' && b.status === 'late') return 1;
                return a.name.localeCompare(b.name, 'zh-CN');
            }).forEach(item => {
                let statusText = '';
                let timeCell = item.checkTime;
                let rowClass = '';

                if (item.status === 'present') {
                    statusText = 'å·²åˆ° (âœ“)';
                } else if (item.status === 'late') {
                    statusText = 'è¿Ÿåˆ° (âš )';
                    rowClass = 'late-row';
                    timeCell = item.checkTime === 'ç¼ºå¸­' ? 'ç¼ºå¸­/æœªåˆ°' : item.checkTime;
                } else {
                    statusText = 'æœªåˆ°/ç¼ºå¸­';
                    rowClass = 'late-row';
                    timeCell = 'æœªç­¾';
                }

                tableRows += `
                    <tr class="${rowClass}">
                        <td>${item.name}</td>
                        <td>${statusText}</td>
                        <td>${timeCell}</td>
                    </tr>
                `;
            });

            // HTML for the new window
            const reportHTML = `
                <html>
                <head>
                    <title>è€ƒå‹¤åå•æŠ¥è¡¨ - ${currentDateTime}</title>
                    <style>
                        /* å¤åˆ¶ report-body å’Œ table çš„æ ·å¼åˆ°æ–°çª—å£ */
                        .report-body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; padding: 20px; background-color: #f8f9fa; color: #333; }
                        .report-title { color: #1a2a6c; border-bottom: 3px solid #fdbb2d; padding-bottom: 10px; margin-bottom: 20px; }
                        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .report-table th { background-color: #e9ecef; color: #1a2a6c; font-weight: bold; }
                        .late-row { background-color: #fdd; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body class="report-body">
                    <h1 class="report-title">ğŸ“ ç­çº§è€ƒå‹¤æŠ¥è¡¨</h1>
                    <p><strong>ç»Ÿè®¡æ—¶é—´:</strong> ${currentDateTime}</p>
                    <p><strong>è€ƒå‹¤æ—¶æ®µ:</strong> ${getCurrentPeriodName() || 'éè€ƒå‹¤æ—¶æ®µ'}</p>
                    <button class="no-print" onclick="window.print()" style="margin-top: 15px; padding: 10px 20px; background: #1a2a6c; color: white; border: none; border-radius: 5px; cursor: pointer;">æ‰“å°æŠ¥è¡¨</button>

                    <table class="report-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">å§“å</th>
                                <th style="width: 30%;">çŠ¶æ€</th>
                                <th style="width: 40%;">ç­¾åˆ°æ—¶é—´/ç¼ºå¸­æ ‡è®° (ç²¾ç¡®åˆ°ç§’)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            // æ‰“å¼€æ–°æ ‡ç­¾é¡µå¹¶å†™å…¥å†…å®¹
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        }

        /* --- åå°ç®¡ç†é€»è¾‘ --- */
        
        function handleLogin() {
            const u = document.getElementById('uName').value.trim();
            const p = document.getElementById('pWord').value;
            // ä¸»ç®¡ç†å‘˜ï¼šxiaoran / lingyi79398
            if(u === 'xiaoran' && p === 'lingyi79398'){
                currentUserRole = 'primary';
                document.getElementById('loginModal').style.display='none';
                document.getElementById('admin-page').style.display='flex';
                renderSettings();
                applyRoleVisibility();
                return;
            }
            // æ¬¡è¦ç®¡ç†å‘˜ï¼šliqi / liqi123123
            if(u === 'liqi' && p === 'liqi123123'){
                currentUserRole = 'secondary';
                document.getElementById('loginModal').style.display='none';
                document.getElementById('admin-page').style.display='flex';
                renderSettings();
                applyRoleVisibility();
                return;
            }
            alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
        }

        function applyRoleVisibility(){
            // æ¬¡è¦ç®¡ç†å‘˜ä¸æ˜¾ç¤ºâ€œäººå‘˜ä¸è‡ªåŠ¨ç­¾åˆ°â€æ•´ä¸ªæ¿å—
            if(currentUserRole === 'secondary'){
                const tabBtn = [...document.querySelectorAll('.admin-sidebar .tab-btn')].find(b=>b.textContent.includes('äººå‘˜ä¸è‡ªåŠ¨ç­¾åˆ°'));
                if(tabBtn) tabBtn.style.display = 'none';
                const tab = document.getElementById('tab-person');
                if(tab) tab.style.display = 'none';
            } else {
                const tabBtn = [...document.querySelectorAll('.admin-sidebar .tab-btn')].find(b=>b.textContent.includes('äººå‘˜ä¸è‡ªåŠ¨ç­¾åˆ°'));
                if(tabBtn) tabBtn.style.display = 'block';
                const tab = document.getElementById('tab-person');
                if(tab) tab.style.display = 'block';
            }
        }

        function closeAdmin() {
            document.getElementById('admin-page').style.display='none';
            // ä¿å­˜é…ç½®
            saveConfig(); 
            initGrid(); // åˆ·æ–°ä¸»ç•Œé¢
        }

        function switchTab(tabId, element) {
            document.querySelectorAll('.settings-group').forEach(g => g.style.display='none');
            document.getElementById(tabId).style.display='block';
            document.querySelectorAll('.admin-sidebar .tab-btn').forEach(b => b.classList.remove('active'));
            element.classList.add('active');
        }

        function renderSettings() {
            // 1. æ—¶é—´
            const pCon = document.getElementById('periodsContainer');
            pCon.innerHTML = '';
            config.periods.forEach((p, idx) => {
                pCon.innerHTML += `
                    <div class="form-row" id="period-row-${idx}">
                        <input type="text" value="${p.name}" class="form-control" onchange="config.periods[${idx}].name=this.value">
                        <input type="time" value="${p.start}" class="form-control" onchange="updatePeriodTime(${idx}, 'start', this.value)">
                        <span>è‡³</span>
                        <input type="time" value="${p.end}" class="form-control" onchange="updatePeriodTime(${idx}, 'end', this.value)">
                        <button class="btn" style="background:#e74c3c; color:white; padding:8px 10px; flex-shrink: 0;" onclick="removePeriod(${idx})">ç§»é™¤</button>
                    </div>
                `;
            });
            // æ·»åŠ æ–°å¢æ—¶é—´æ®µæŒ‰é’®
            pCon.innerHTML += `
                <div class="form-row" style="justify-content:center; margin-top: 15px;">
                    <button class="btn btn-save" onclick="addPeriod()">+ æ–°å¢æ—¶é—´æ®µ</button>
                </div>
            `;

            // 2. è‡ªåŠ¨ç­¾åˆ°å‹¾é€‰
            const autoGrid = document.getElementById('autoSignGrid');
            autoGrid.innerHTML = '';
            ALL_NAMES.forEach(name => {
                const isAuto = config.autoSignList.includes(name);
                autoGrid.innerHTML += `
                    <label class="check-item">
                        <input type="checkbox" ${isAuto ? 'checked' : ''} onchange="toggleAutoSign('${name}', this.checked)">
                        ${name}
                    </label>
                `;
            });

            // æ ¹æ®å½“å‰ç”¨æˆ·è§’è‰²è°ƒæ•´å¯è§æ€§
            applyRoleVisibility();
        }
        
        function addPeriod() {
            config.periods.push({ name: "æ–°æ—¶æ®µ", start: "00:00", end: "00:30" });
            renderSettings(); // é‡æ–°æ¸²æŸ“é…ç½®ç•Œé¢
        }

        function removePeriod(index) {
            if (config.periods.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè€ƒå‹¤æ—¶æ®µã€‚');
                return;
            }
            config.periods.splice(index, 1);
            renderSettings(); // é‡æ–°æ¸²æŸ“é…ç½®ç•Œé¢
        }

        // æ—¶é—´è¾“å…¥æ ¡éªŒ
        function updatePeriodTime(index, key, value) {
            // ç®€å•çš„ HH:MM æ ¼å¼æ ¡éªŒ
            if (/^\d{2}:\d{2}$/.test(value) && getMins(value) !== -1) {
                config.periods[index][key] = value;
            } else {
                alert('æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯ HH:MM (ä¾‹å¦‚ 18:30)');
            }
        }

        function toggleAutoSign(name, checked) {
            if(currentUserRole === 'secondary') return; // secondary æ— æƒé™ä¿®æ”¹
            if(checked) {
                if(!config.autoSignList.includes(name)) config.autoSignList.push(name);
            } else {
                config.autoSignList = config.autoSignList.filter(n => n !== name);
            }
        }

        function saveConfig() {
            localStorage.setItem('attendance_v4_config', JSON.stringify(config));
        }

        /* --- ç´ æå¯¼å…¥ (Base64) --- */
        function importFile(input, key) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    localStorage.setItem(key, e.target.result);
                    alert('å¯¼å…¥æˆåŠŸï¼');
                    loadTheme();
                } catch(err) {
                    alert('å›¾ç‰‡å¤ªå¤§äº†ï¼Œæ— æ³•ä¿å­˜ï¼è¯·ä½¿ç”¨å°äº 2MB çš„å›¾ç‰‡ã€‚');
                }
            };
            reader.readAsDataURL(file);
        }

        function clearStorage(key) {
            localStorage.removeItem(key);
            location.reload();
        }

        // Run
        init();

    </script>
</body>
</html>
